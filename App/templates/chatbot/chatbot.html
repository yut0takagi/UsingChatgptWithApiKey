{% extends "layoutForLogined.html" %}
{% block content %}

<h2 class="text-3xl font-bold text-gray-800"> チャットボット</h2>

<!-- チャット表示エリア -->
<div id="chat-box" class="flex-1 overflow-y-auto bg-white shadow-md rounded-lg p-4 mt-4">
    <div class="text-gray-600">👋 AI チャットボットへようこそ！</div>
</div>

<!-- メッセージ送信フォーム（画面下部に固定） -->
<form id="chat-form" class="fixed bottom-0 left-64 w-[calc(100%-16rem)] bg-white p-4 border-t border-gray-300 flex">
    <input type="text" id="user-input" class="flex-1 border border-gray-300 rounded-l-md p-2" placeholder="メッセージを入力">
    <input type="file" id="image-input" accept="image/*" class="hidden">
    <button type="button" id="image-button" class="bg-gray-600 text-white px-4 py-2 hover:bg-gray-500">
        📷
    </button>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-500">
        送信
    </button>
</form>

<script>
  let selectedImage = null;

  document.getElementById("image-button").addEventListener("click", function() {
    document.getElementById("image-input").click();
  });

  document.getElementById("image-input").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      selectedImage = file;
      // 画像が選択されたことをユーザーに通知
      let chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class="text-right text-blue-600 mt-2">📷 画像が選択されました</div>`;
    }
  });

  document.getElementById("chat-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      
      let userInput = document.getElementById("user-input").value;
      if (!userInput.trim() && !selectedImage) return;
      
      let chatBox = document.getElementById("chat-box");

      // ユーザーのメッセージを追加
      let userMessage = `<div class="text-right text-blue-600 mt-2">🧑‍💻 ${userInput}</div>`;
      chatBox.innerHTML += userMessage;
      document.getElementById("user-input").value = "";

      // 画像がある場合はBase64エンコード
      let imageData = null;
      if (selectedImage) {
        imageData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(selectedImage);
        });
        selectedImage = null;
        document.getElementById("image-input").value = "";
      }

      // Flask に送信
      let response = await fetch("/chatbot/chat", {
          method: "POST",
          body: JSON.stringify({ 
            message: userInput,
            image: imageData
          }),
          headers: { "Content-Type": "application/json" }
      });

      let data = await response.json();

      // AIのメッセージを追加
      let botMessage = `<div class="text-left text-green-600 mt-2">🤖 ${data.response}</div>`;
      chatBox.innerHTML += botMessage;
      
      // チャットボックスを最下部へスクロール
      chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>
{% endblock %}