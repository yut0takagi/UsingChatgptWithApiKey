{% extends "layoutForLogined.html" %}
{% block content %}

<h2 class="text-3xl font-bold text-gray-800"> ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ</h2>

<!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div id="chat-box" class="flex-1 overflow-y-auto bg-white shadow-md rounded-lg p-4 mt-4">
    <div class="text-gray-600">ğŸ‘‹ AI ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¸ã‚ˆã†ã“ãï¼</div>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç”»é¢ä¸‹éƒ¨ã«å›ºå®šï¼‰ -->
<form id="chat-form" class="fixed bottom-0 left-64 w-[calc(100%-16rem)] bg-white p-4 border-t border-gray-300 flex">
    <input type="text" id="user-input" class="flex-1 border border-gray-300 rounded-l-md p-2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <input type="file" id="image-input" accept="image/*" class="hidden">
    <button type="button" id="image-button" class="bg-gray-600 text-white px-4 py-2 hover:bg-gray-500">
        ğŸ“·
    </button>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-r-md hover:bg-blue-500">
        é€ä¿¡
    </button>
</form>

<script>
  let selectedImage = null;

  document.getElementById("image-button").addEventListener("click", function() {
    document.getElementById("image-input").click();
  });

  document.getElementById("image-input").addEventListener("change", function(event) {
    const file = event.target.files[0];
    if (file) {
      selectedImage = file;
      // ç”»åƒãŒé¸æŠã•ã‚ŒãŸã“ã¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
      let chatBox = document.getElementById("chat-box");
      chatBox.innerHTML += `<div class="text-right text-blue-600 mt-2">ğŸ“· ç”»åƒãŒé¸æŠã•ã‚Œã¾ã—ãŸ</div>`;
    }
  });

  document.getElementById("chat-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      
      let userInput = document.getElementById("user-input").value;
      if (!userInput.trim() && !selectedImage) return;
      
      let chatBox = document.getElementById("chat-box");

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      let userMessage = `<div class="text-right text-blue-600 mt-2">ğŸ§‘â€ğŸ’» ${userInput}</div>`;
      chatBox.innerHTML += userMessage;
      document.getElementById("user-input").value = "";

      // ç”»åƒãŒã‚ã‚‹å ´åˆã¯Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
      let imageData = null;
      if (selectedImage) {
        imageData = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(selectedImage);
        });
        selectedImage = null;
        document.getElementById("image-input").value = "";
      }

      // Flask ã«é€ä¿¡
      let response = await fetch("/chatbot/chat", {
          method: "POST",
          body: JSON.stringify({ 
            message: userInput,
            image: imageData
          }),
          headers: { "Content-Type": "application/json" }
      });

      let data = await response.json();

      // AIã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
      let botMessage = `<div class="text-left text-green-600 mt-2">ğŸ¤– ${data.response}</div>`;
      chatBox.innerHTML += botMessage;
      
      // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      chatBox.scrollTop = chatBox.scrollHeight;
  });
</script>
{% endblock %}